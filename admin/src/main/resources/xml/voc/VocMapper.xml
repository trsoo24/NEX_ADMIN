<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.example.admin.voc.mapper.VocMapper">
    <!-- provisioning info -->
    <insert id="insertProvisioningInfo" parameterType="com.example.admin.voc.dto.ProvisioningInfo">
        INSERT INTO TB_PROVISIONING_INFO(SUB_NO, CTN, VERSION, CORRELATION_ID, OPERATOR_USER_TOKEN, USER_LOCALE,
                                         BILLING_AGREEMENT, RESULT, IS_PROVISIONED, TOS_URL, TOS_VERSION, ACCOUNT_TYPE,
                                         GET_PROVISIONING_TRANSACTION_ID, TRANSACTION_LIMIT, PAYMENT_TYPE, UPDATE_DT,
                                         CREATE_DT)
        VALUES (#{subNo}, #{ctn}, #{version}, #{correlationId}, #{operatorUserToken}, #{userLocale},
                #{billingAgreement}, #{result}, #{isProvisioned}, #{tosUrl}, #{tosVersion}, #{accountType},
                #{getProvisioningTransactionId}, #{transactionLimit}, #{paymentType}, #{updateDt}, #{createDt})
    </insert>

    <!-- sms info -->
    <insert id="insertSmsInfo" parameterType="com.example.admin.voc.dto.SmsInfo">
        INSERT INTO TB_SMSMO_INFO(CTN, GOOGLE_USER_TOKEN, RESULT, PAYMENT_TYPE, OPERATOR_USER_TOKEN, UPDATE_DT,
                                  CREATE_DT, TOS_VERSION, TOS_DATE)
        VALUES (#{ctn}, #{googleUserToken}, #{result}, #{paymentType}, #{operatorUserToken}, #{updateDt}, #{createDt},
                #{tosVersion}, #{tosDate})
    </insert>

    <select id="selectSmsmoListByCtn" parameterType="map" resultType="com.example.admin.voc.dto.SmsInfoDto">
        SELECT
        GOOGLE_USER_TOKEN googleUserToken,
        OPERATOR_USER_TOKEN operatorUserToken,
        OUT_EXPIRE_TIME expireTime,
        TO_CHAR(UPDATE_DT, 'YYYY-MM-DD') updateDT,
        TO_CHAR(CREATE_DT, 'YYYY-MM-DD') createDT
        FROM TB_SMSMO_INFO
        WHERE 1 = 1
        <if test="ctn != null and ctn != ''">
            AND REPLACE(CTN, '-', '') = #{ctn}
        </if>
    </select>

    <select id="selectProvisioningListByCtn" parameterType="map"
            resultType="com.example.admin.voc.dto.ProvisionInfoDto">
        SELECT
        SUB_NO subNo,
        IS_PROVISIONED isProvisioned,
        OPERATOR_USER_TOKEN operatorUserToken,
        TO_CHAR(UPDATE_DT, 'YYYY-MM-DD') updateDT,
        TO_CHAR(CREATE_DT, 'YYYY-MM-DD') createDT
        FROM TB_PROVISIONING_INFO
        WHERE 1 = 1
        <if test="ctn != null and ctn != ''">
            AND REPLACE(CTN, '-', '') = #{ctn}
        </if>
    </select>

    <delete id="deleteVocHistory" parameterType="Integer">
        DELETE FROM TB_VOC_HISTORY
        WHERE 1 = 1
        <if test="id != null and id != ''">
            AND VOC_ID = #{id}
        </if>
    </delete>

    <insert id="insertVocHistory" parameterType="com.example.admin.voc.dto.InsertVocDivision">
        INSERT INTO TB_VOC_HISTORY(REG_DATE, CTN, DCB, CONTENT, WRITER
        <if test="division1 != null">, DIVISION_1</if>
        <if test="division2 != null">, DIVISION_2</if>
        <if test="division3 != null">, DIVISION_3</if>
        <if test="answer1 != null">, ANSWER_1</if>
        <if test="answer2 != null">, ANSWER_2</if>
        <if test="answer3 != null">, ANSWER_3</if>)
        VALUES (DATE_FORMAT(NOW(), '%Y-%m-%d'), #{ctn}, #{dcb}, #{content}
        <if test="division1 != null">, #{division1}</if>
        <if test="division2 != null">, #{division2}</if>
        <if test="division3 != null">, #{division3}</if>
        <if test="answer1 != null">, #{answer1}</if>
        <if test="answer2 != null">, #{answer2}</if>
        <if test="answer3 != null">, #{answer3}</if>
        )
    </insert>

    <update id="updateVocHistory" parameterType="com.example.admin.voc.dto.UpdateVocHistoryDto">
        UPDATE TB_VOC_HISTORY
        <set>
            <if test="answer1 != null">ANSWER_1 = #{answer1},</if>
            <if test="answer2 != null">ANSWER_2 = #{answer2},</if>
            <if test="answer3 != null">ANSWER_3 = #{answer3}</if>
        </set>
        WHERE VOC_ID = #{vocId}
    </update>

    <select id="selectVocHistory" parameterType="map" resultType="com.example.admin.voc.dto.VocDivision">
        SELECT * FROM TB_VOC_HISTORY
        WHERE 1 = 1
        <if test="writer != null and writer != ''">
            AND WRITER LIKE CONCAT('%', #{writer}, '%')
        </if>
    </select>
</mapper>